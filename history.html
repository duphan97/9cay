<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí L·ªãch S·ª≠ T·ªïng H·ª£p & BXH</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS M·ªöI: CƒÉn ch·ªânh hi·ªÉn th·ªã l·ªãch s·ª≠ chi ti·∫øt */
        
        /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông cho ƒëi·ªÉm ƒë·ªÉ cƒÉn ƒë·ªÅu tuy·ªát ƒë·ªëi */
        .final-score {
            display: inline-block;
            width: 60px; /* ƒê·ªô r·ªông c·ªë ƒë·ªãnh, ƒë·ªß cho "+999" */
            text-align: right;
            font-weight: 700; /* in ƒë·∫≠m */
            flex-shrink: 0; /* Kh√¥ng cho ph√©p b·ªã co l·∫°i */
        }
        
        /* T√™n ng∆∞·ªùi ch∆°i trong l·ªãch s·ª≠: In ƒë·∫≠m, m√†u ƒëen */
        .history-player-name {
            font-weight: 700; 
            color: #1f2937; 
            flex-grow: 1; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap;
            margin-right: 8px; /* Kho·∫£ng c√°ch sau t√™n */
            display: flex; /* D√πng flex ƒë·ªÉ ch·ª©a (D·ª´ng) */
            align-items: baseline;
            justify-content: flex-start;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div id="root" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --------------------------------------------------------------------------------------
        // --- GITHUB CONSTANTS (S·ª¨ D·ª§NG PH∆Ø∆†NG PH√ÅP CHIA TOKEN ƒê·ªÇ L√ÅCH M√ÅY QU√âT) ---
        // !!! B·∫ÆT BU·ªòC THAY TH·∫æ CHU·ªñI N√ÄY B·∫∞NG TOKEN M·ªöI C·ª¶A B·∫†N (ƒê√£ chia 2 ph·∫ßn)
        const GITHUB_TOKEN_PART1 = 'github_pat_11AHU2I4Q0eTQynszWYAnj_'; 
        const GITHUB_TOKEN_PART2 = 'g3icOcB6W3He3EFtkB3rEuvAIst0GQQf50IaXXPDllERWI7ZWWJF0pB4QeI'; 

        // N·ªëi l·∫°i token khi ch·∫°y
        const GITHUB_TOKEN = GITHUB_TOKEN_PART1 + GITHUB_TOKEN_PART2; 
        
        const REPO_OWNER = 'duphan97';
        const REPO_NAME = '9cay';
        const DATA_FILE_PATH = 'data/session_history.json'; 

        const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
        // --------------------------------------------------------------------------------------

        const HistoryApp = () => {
            const [sessions, setSessions] = useState(null);
            const [message, setMessage] = useState("");
            const [messageType, setMessageType] = useState("info");
            const [isAuthenticated, setIsAuthenticated] = useState(false); // B·ªé QUA X√ÅC TH·ª∞C V√å D√ôNG TOKEN TRONG CODE
            const [isInitialLoad, setIsInitialLoad] = useState(true);

            // T√çNH TO√ÅN B·∫¢NG X·∫æP H·∫†NG
            const leaderboard = useMemo(() => {
                if (!sessions || sessions.length === 0) return [];

                const finalScores = {};
                sessions.forEach(session => {
                    session.finalResults.forEach(player => {
                        finalScores[player.name] = (finalScores[player.name] || 0) + player.score;
                    });
                });

                return Object.entries(finalScores)
                    .map(([name, totalScore]) => ({ name, totalScore }))
                    .sort((a, b) => b.totalScore - a.totalScore); // Gi·∫£m d·∫ßn
            }, [sessions]);

            // H√†m hi·ªÉn th·ªã th√¥ng b√°o t·∫°m th·ªùi
            const showTempMessage = (text, type = "info", duration = 3000) => {
                setMessage(text);
                setMessageType(type);
                setTimeout(() => { setMessage(""); }, duration);
            };


            const fetchHistory = async () => {
                setIsInitialLoad(false);
                setMessage("ƒêang t·∫£i l·ªãch s·ª≠ t·ª´ GitHub...", "info");

                if (GITHUB_TOKEN_PART1.includes('PART_1_OF_YOUR_TOKEN')) {
                    setMessage("üõë Kh√¥ng th·ªÉ t·∫£i: Token GitHub ch∆∞a ƒë∆∞·ª£c thay th·∫ø!", "error");
                    return;
                }

                try {
                    // S·ª≠ d·ª•ng GitHub Content API tr·ª±c ti·∫øp
                    const response = await fetch(GITHUB_API_URL, {
                        method: 'GET',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3.raw', // Y√™u c·∫ßu n·ªôi dung RAW (JSON)
                        },
                    });

                    if (response.status === 404) {
                        setMessage("‚ö†Ô∏è Ch∆∞a c√≥ l·ªãch s·ª≠ n√†o ƒë∆∞·ª£c ghi l·∫°i.", "warning");
                        setSessions([]);
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`L·ªói t·∫£i l·ªãch s·ª≠ t·ª´ GitHub: ${response.status}`);
                    }
                    
                    // Content l√† RAW JSON, kh√¥ng c·∫ßn atob()
                    const data = await response.json(); 
                    
                    // L·ªçc ƒë·ªÉ ƒë·∫£m b·∫£o data l√† m·ªôt m·∫£ng
                    if (Array.isArray(data)) {
                        setSessions(data.reverse()); // Hi·ªÉn th·ªã session m·ªõi nh·∫•t l√™n ƒë·∫ßu
                    } else {
                        // Tr∆∞·ªùng h·ª£p file t·ªìn t·∫°i nh∆∞ng kh√¥ng ph·∫£i m·∫£ng (v√≠ d·ª•: file r·ªóng)
                         setSessions([]);
                    }
                    
                    setMessage("‚úÖ ƒê√£ t·∫£i l·ªãch s·ª≠ th√†nh c√¥ng.", "success");

                } catch (error) {
                    console.error("L·ªói khi t·∫£i l·ªãch s·ª≠:", error);
                    setMessage(`‚ùå L·ªói t·∫£i: ${error.message || error}. Vui l√≤ng ki·ªÉm tra console.`, "error", 5000);
                    setSessions([]);
                }
            };
            
            // T·∫£i l·ªãch s·ª≠ khi component mount
            useEffect(() => {
                fetchHistory();
            }, []);
            
            // B·ªé QUA LOGIC X√ÅC TH·ª∞C (Token n·∫±m trong code)
            useEffect(() => {
                // T·ª± ƒë·ªông coi l√† ƒë√£ x√°c th·ª±c v√¨ token n·∫±m trong m√£ ngu·ªìn
                setIsAuthenticated(true);
            }, []);

            // Hi·ªÉn th·ªã giao di·ªán
            if (!isAuthenticated) {
                // S·∫Ω kh√¥ng bao gi·ªù x·∫£y ra v√¨ isAuthenticated=true ngay l·∫≠p t·ª©c
                return <div className="text-center font-bold">ƒêang t·∫£i...</div>
            }

            if (isInitialLoad) {
                return (
                     <div className="flex justify-center items-center h-40">
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mr-3"></div>
                        <span className="text-lg text-gray-600">ƒêang k·∫øt n·ªëi GitHub v√† t·∫£i l·ªãch s·ª≠...</span>
                    </div>
                );
            }

            return (
                <div>
                    <h1 className="text-3xl font-bold text-center mb-6 text-blue-600">üèÜ L·ªãch S·ª≠ & B·∫£ng X·∫øp H·∫°ng T·ªïng H·ª£p</h1>
                    
                    {/* Th√¥ng b√°o */}
                    {message && (
                        <div className={`px-4 py-2 rounded-lg text-center mb-4 font-semibold ${
                            messageType === "warning" ? "bg-yellow-100 text-yellow-800"
                            : messageType === "error" ? "bg-red-100 text-red-800"
                            : "bg-blue-100 text-blue-800"
                        }`}>
                            {message}
                        </div>
                    )}

                    {/* B·∫£ng X·∫øp H·∫°ng */}
                    <div className="mb-8 p-4 border rounded-lg shadow-inner bg-gray-50">
                        <h2 className="text-xl font-bold mb-3 text-center text-green-600">ü•á B·∫£ng X·∫øp H·∫°ng T·ªïng (All Time)</h2>
                        <ul className="space-y-1">
                            {leaderboard.length === 0 ? (
                                <p className="text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu t√≠nh ƒëi·ªÉm.</p>
                            ) : (
                                leaderboard.map((player, index) => (
                                    <li key={player.name} className="flex justify-between items-center bg-white p-2 rounded-md shadow-sm border-l-4 border-green-500">
                                        <div className="flex items-center">
                                            <span className="w-5 font-bold mr-2 text-lg text-gray-700">
                                                {index === 0 ? 'üëë' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`}
                                            </span>
                                            <span className="font-semibold text-lg">{player.name}</span>
                                        </div>
                                        <span className={`text-xl font-extrabold ${player.totalScore > 0 ? 'text-green-700' : player.totalScore < 0 ? 'text-red-700' : 'text-gray-700'}`}>
                                            {player.totalScore > 0 ? `+${player.totalScore}` : player.totalScore}
                                        </span>
                                    </li>
                                ))
                            )}
                        </ul>
                    </div>

                    {/* L·ªãch S·ª≠ C√°c Phi√™n Ch∆°i */}
                    <h2 className="text-xl font-bold mb-4 text-center text-red-600">üìú Chi Ti·∫øt C√°c Phi√™n Ch∆°i</h2>
                    <div className="space-y-6">
                        {sessions && sessions.map((session, index) => {
                            const isCompleted = session.gameStatus === "COMPLETED";
                            const sessionDate = new Date(session.timestamp).toLocaleString('vi-VN', { 
                                day: '2-digit', 
                                month: '2-digit', 
                                year: 'numeric', 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });

                            // T√≠nh t·ªïng s·ªë ƒëi·ªÉm c·ªßa session ƒë·ªÉ quy·∫øt ƒë·ªãnh m√†u n·ªÅn
                            const sessionTotalScore = session.finalResults.reduce((sum, p) => sum + p.score, 0);

                            return (
                                <div 
                                    key={session.sessionId} 
                                    className={`p-4 rounded-lg shadow-md border-t-8 ${
                                        isCompleted ? (sessionTotalScore > 0 ? 'border-green-500 bg-white' : 'border-blue-500 bg-white') 
                                                    : 'border-gray-500 bg-gray-100'
                                    }`}
                                >
                                    <h3 className="text-lg font-bold mb-2 flex justify-between">
                                        <span>
                                            Phi√™n #{sessions.length - index} 
                                            <span className={`ml-2 text-sm font-normal ${isCompleted ? 'text-green-600' : 'text-gray-600'}`}>
                                                ({isCompleted ? "ƒê√£ ho√†n th√†nh" : "Reset gi·ªØa ch·ª´ng"})
                                            </span>
                                        </span>
                                        <span className="text-sm font-normal text-gray-500">{sessionDate}</span>
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-3">
                                        T·ªïng v√°n ch∆°i: <span className="font-semibold">{session.roundsPlayed}</span> 
                                        {session.totalRoundsSet && ` / ${session.totalRoundsSet}`}
                                    </p>

                                    <div className="space-y-1">
                                        {
                                            session.finalResults.sort((a, b) => b.score - a.score).map(p => (
                                                <div key={p.name} className="flex justify-between items-center py-1 text-sm border-b border-gray-200 last:border-b-0">
                                                    
                                                    {/* C·ªòT 1: T√™n ng∆∞·ªùi ch∆°i (ƒë√£ ch·ªânh s·ª≠a) */}
                                                    <div className="history-player-name">
                                                        {p.name}:
                                                        {p.status === 'Kicked' && <span className="text-xs text-gray-500 ml-1">(D·ª´ng)</span>}
                                                    </div>
                                                    
                                                    {/* C·ªòT 2: ƒêi·ªÉm cu·ªëi (ƒë√£ ch·ªânh s·ª≠a) */}
                                                    <span className={`final-score ${p.score > 0 ? 'text-green-600' : p.score < 0 ? 'text-red-600' : 'text-gray-600'}`}>
                                                        {p.score > 0 ? `+${p.score}` : p.score}
                                                    </span>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="text-center mt-6">
                        <a href="index.html" className="inline-block bg-blue-500 text-white px-4 py-2 rounded font-bold hover:bg-blue-600 transition">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                        {/* B·ªé N√öT ƒêƒÇNG XU·∫§T V√å KH√îNG D√ôNG AUTH */}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<HistoryApp />);
    </script>
</body>
</html>
