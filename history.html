<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìú L·ªãch S·ª≠ T·ªïng H·ª£p & BXH</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> 
    <style>
        /* CSS M·ªöI: CƒÉn ch·ªânh hi·ªÉn th·ªã l·ªãch s·ª≠ chi ti·∫øt */
        
        /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông cho ƒëi·ªÉm ƒë·ªÉ cƒÉn ƒë·ªÅu tuy·ªát ƒë·ªëi */
        .final-score {
            display: inline-block;
            width: 60px; /* ƒê·ªô r·ªông c·ªë ƒë·ªãnh, ƒë·ªß cho "+999" */
            text-align: right;
            font-weight: 700; /* in ƒë·∫≠m */
            flex-shrink: 0; /* Kh√¥ng cho ph√©p b·ªã co l·∫°i */
        }
        
        /* T√™n ng∆∞·ªùi ch∆°i trong l·ªãch s·ª≠: In ƒë·∫≠m, m√†u ƒëen */
        .history-player-name {
            font-weight: 700; 
            color: #1f2937; 
            flex-grow: 1; 
            white-space: nowrap; /* NgƒÉn t√™n b·ªã xu·ªëng d√≤ng */
            overflow: hidden; /* ·∫®n ph·∫ßn b·ªã tr√†n */
            text-overflow: ellipsis; /* Hi·ªÉn th·ªã d·∫•u ba ch·∫•m */
        }
        
        /* ƒê·∫£m b·∫£o to√†n b·ªô ·ª©ng d·ª•ng s·ª≠ d·ª•ng font-sans */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f3f4f6; /* M√†u n·ªÅn nh·∫π */
        }
        
        /* CƒÉn gi·ªØa n·ªôi dung ch√≠nh */
        #root {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- C·∫§U H√åNH GITHUB (PH·∫¢I KH·ªöP V·ªöI index.html) ---
        const REPO_OWNER = 'duphan97';
        const REPO_NAME = '9cay';
        const DATA_FILE_PATH = 'data/session_history.json'; 
        // Endpoint ƒë·ªÉ l·∫•y n·ªôi dung file JSON ƒë√£ ƒë∆∞·ª£c Base64 encoded
        const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
        // --- END C·∫§U H√åNH GITHUB ---


        // --- C·∫§U H√åNH B·∫¢O M·∫¨T PBKDF2 (D·ªÆ LI·ªÜU C·ª¶A B·∫†N) ---
        // Thu·∫≠t to√°n: PBKDF2WithHmacSHA256
        
        // 1. HASH C·ª¶A M·∫¨T KH·∫®U (Derived Key)
        const SECRET_PASSWORD_HASH_B64 = 'DfhK0GwpwGTAqvgGMNTYVyjjGo46w43K5Qs1h2OTqaA='; 
        // 2. SALT (Mu·ªëi - Base64 Encoded)
        const FIXED_SALT_B64 = 'WPJeEB+s7J2CPN8Mg5oTqA==';
        // 3. S·ªê V√íNG L·∫∂P (Iterations - TƒÉng t·ªëc ƒë·ªô load)
        const ITERATIONS = 1000;
        // 4. ƒê·ªò D√ÄI KEY (256 bits = 32 bytes)
        const KEY_SIZE_WORDS = 256 / 8 / 4; 

        // H√†m Hashing b·∫±ng PBKDF2 (S·ª≠ d·ª•ng CryptoJS)
        const hashPasswordPBKDF2 = (password) => {
            // Parse Salt t·ª´ Base64 sang WordArray
            const saltWords = CryptoJS.enc.Base64.parse(FIXED_SALT_B64);

            // D√πng PBKDF2
            const key = CryptoJS.PBKDF2(password, saltWords, {
                keySize: KEY_SIZE_WORDS, // 256 bits
                iterations: ITERATIONS,
                hasher: CryptoJS.algo.SHA256 // Thu·∫≠t to√°n bƒÉm c∆° s·ªü
            });

            // Tr·∫£ v·ªÅ Hash d∆∞·ªõi d·∫°ng Base64 String
            return key.toString(CryptoJS.enc.Base64);
        };
        // --- END C·∫§U H√åNH B·∫¢O M·∫¨T PBKDF2 ---


        // --- BASE64 AN TO√ÄN CHO UNICODE (GI·ªÆ NGUY√äN) ---
        const b64ToUnicode = (str) => decodeURIComponent(
            Array.prototype.map.call(atob(str), (c) => 
                '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
            ).join('')
        );
        // --- END FIX ---


        // H√†m T·∫£i l·ªãch s·ª≠ tr·ª±c ti·∫øp t·ª´ GitHub (CH·ªà G·ªåI KHI ƒê√É X√ÅC TH·ª∞C)
        const fetchHistoryFromGitHub = async () => {
            const response = await fetch(GITHUB_API_URL, {
                method: 'GET',
                headers: {
                    'Accept': 'application/vnd.github.v3+json', 
                },
            });

            if (response.status === 404) {
                return []; 
            }
            if (!response.ok) {
                throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu t·ª´ GitHub: ${response.statusText}`);
            }

            const fileData = await response.json();
            
            const encodedContent = fileData.content;
            let sessionsData;
            try {
                const jsonString = b64ToUnicode(encodedContent); 
                sessionsData = JSON.parse(jsonString);
            } catch (e) {
                console.error("L·ªói Decode/Parse JSON:", e);
                throw new Error("D·ªØ li·ªáu l·ªãch s·ª≠ kh√¥ng h·ª£p l·ªá (l·ªói Decode/JSON).");
            }
            
            return sessionsData; 
        };

        // H√†m t√≠nh t·ªïng ƒëi·ªÉm to√†n th·ªùi gian (All-Time Score)
        const calculateAllTimeScores = (sessions) => {
            if (!sessions || sessions.length === 0) return [];
            
            const scoresMap = {};

            sessions.forEach(session => {
                if (Array.isArray(session.finalResults)) {
                    session.finalResults.forEach(player => {
                        const { name, score } = player;
                        scoresMap[name] = (scoresMap[name] || 0) + score;
                    });
                }
            });

            const scoreboard = Object.keys(scoresMap).map(name => ({
                name,
                totalScore: scoresMap[name]
            })).sort((a, b) => b.totalScore - a.totalScore); 

            return scoreboard;
        };

        // Helper cho hi·ªÉn th·ªã th·ªùi gian
        const formatSessionDate = (isoString) => {
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return isoString ? isoString.substring(0, 10) : 'N/A';
            }
        };


        function HistoryApp() {
            const [sessions, setSessions] = useState(null);
            const [loading, setLoading] = useState(false);
            
            // TR·∫†NG TH√ÅI X√ÅC TH·ª∞C
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState(null);

            // X·ª¨ L√ù ƒêƒÇNG NH·∫¨P
            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setAuthError(null);

                // 1. T·∫°o Hash b·∫±ng PBKDF2 (S·∫Ω m·∫•t 1 kho·∫£ng th·ªùi gian nh·ªè do ITERATIONS = 1000)
                const inputHash = hashPasswordPBKDF2(password);
                
                // 2. SO S√ÅNH HASH
                if (inputHash === SECRET_PASSWORD_HASH_B64) {
                    
                    // M·∫≠t kh·∫©u ƒë√∫ng, b·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu
                    try {
                        const data = await fetchHistoryFromGitHub();
                        setSessions(data);
                        setIsAuthenticated(true); // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
                        setPassword(''); // X√≥a m·∫≠t kh·∫©u kh·ªèi b·ªô nh·ªõ
                    } catch (err) {
                        console.error("L·ªói t·∫£i l·ªãch s·ª≠:", err.message);
                        setAuthError("ƒêƒÉng nh·∫≠p th√†nh c√¥ng nh∆∞ng l·ªói t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠."); 
                    }
                } else {
                    // M·∫≠t kh·∫©u sai
                    setAuthError("M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c. Vui l√≤ng th·ª≠ l·∫°i.");
                    setPassword('');
                }
                
                // Th√™m ƒë·ªô tr·ªÖ c·ªë ƒë·ªãnh nh·ªè ƒë·ªÉ ch·ªëng timing attack
                setTimeout(() => setLoading(false), 500); 
            };

            const allTimeScores = useMemo(() => calculateAllTimeScores(sessions), [sessions]);


            // --- GIAO DI·ªÜN X√ÅC TH·ª∞C ---
            if (!isAuthenticated) {
                return (
                    <div className="flex flex-col items-center justify-center h-full min-h-[50vh] p-4">
                        <form onSubmit={handleLogin} className="w-full max-w-sm bg-white p-8 rounded-xl shadow-2xl border border-purple-200">
                            <h2 className="text-3xl font-extrabold text-center text-purple-700 mb-6">üîí Truy C·∫≠p L·ªãch S·ª≠</h2>
                            <input
                                type="password"
                                placeholder="Nh·∫≠p M·∫≠t Kh·∫©u"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg mb-4 text-lg focus:ring-4 focus:ring-purple-300 focus:border-purple-500 transition duration-150"
                                disabled={loading}
                                required
                            />
                            {authError && <p className="text-red-600 text-sm mb-4 text-center font-medium">{authError}</p>}
                            <button
                                type="submit"
                                className="w-full bg-purple-600 text-white font-bold text-lg py-3 rounded-lg hover:bg-purple-700 transition duration-200 disabled:bg-purple-300 shadow-md"
                                disabled={loading || !password}
                            >
                                {loading ? 'ƒêang Ki·ªÉm Tra...' : 'M·ªü L·ªãch S·ª≠'}
                            </button>
                        </form>
                    </div>
                );
            }
            
            // --- Giao di·ªán T·∫£i/L·ªói sau khi ƒêƒÉng nh·∫≠p th√†nh c√¥ng ---
            if (loading) {
                return (
                    <div className="text-center p-8">
                        <p className="font-semibold mb-4 text-blue-600">ƒêang t·∫£i l·ªãch s·ª≠ t·ªïng h·ª£p...</p>
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto"></div>
                    </div>
                );
            }

            if (authError && !sessions) { 
                return (
                    <div className="text-center p-8 bg-red-100 border border-red-400 rounded-xl shadow-lg">
                        <p className="font-bold text-red-700 mb-3 text-lg">‚ùå L·ªói T·∫£i D·ªØ Li·ªáu</p>
                        <p className="text-base text-gray-700">{authError}</p>
                        <button 
                            onClick={() => setIsAuthenticated(false)}
                            className="inline-block bg-gray-500 text-white px-5 py-2 rounded-lg font-bold hover:bg-gray-600 transition mt-4 shadow-md">
                            ‚Ü©Ô∏è Quay l·∫°i ƒêƒÉng nh·∫≠p
                        </button>
                    </div>
                );
            }

            if (!sessions || sessions.length === 0) {
                return (
                    <div className="text-center p-8 bg-yellow-100 border border-yellow-400 rounded-xl shadow-lg">
                        <p className="font-bold text-yellow-700 text-lg">üìú Ch∆∞a C√≥ D·ªØ Li·ªáu L·ªãch S·ª≠</p>
                        <p className="text-base text-gray-600 mt-2">H√£y ho√†n th√†nh m·ªôt phi√™n ch∆°i ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông l∆∞u.</p>
                        <a href="index.html" className="inline-block bg-blue-500 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-600 transition mt-4 shadow-md">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                );
            }

            // --- Giao di·ªán L·ªãch s·ª≠ & BXH ---
            return (
                <div>
                    <h1 className="text-3xl font-extrabold text-center text-purple-700 mb-8">üìú L·ªãch S·ª≠ & B·∫£ng X·∫øp H·∫°ng T·ªïng H·ª£p ({sessions.length} Phi√™n)</h1>
                    
                    {/* B·∫¢NG X·∫æP H·∫†NG T·ªîNG ƒêI·ªÇM TO√ÄN TH·ªúI GIAN */}
                    <div className="mb-10 p-5 bg-blue-50 border border-blue-200 rounded-xl shadow-xl">
                        <h2 className="text-2xl font-bold text-blue-800 mb-4 text-center border-b pb-2">üèÜ B·∫£ng X·∫øp H·∫°ng T·ªïng ƒêi·ªÉm To√†n Th·ªùi Gian</h2>
                        <div className="space-y-3">
                            {allTimeScores.map((p, index) => (
                                <div key={p.name} className={`flex justify-between items-center p-3 rounded-lg transition duration-150 ${index < 3 ? 'bg-yellow-200 font-extrabold border-l-4 border-yellow-600' : 'bg-white border hover:bg-gray-50'}`}>
                                    <span className="text-xl">
                                        {index === 0 && 'ü•á'}
                                        {index === 1 && 'ü•à'}
                                        {index === 2 && 'ü•â'}
                                        {index >= 3 && <span className="text-gray-500 font-bold w-6 inline-block text-center">{index + 1}.</span>}
                                        {p.name}
                                    </span>
                                    <span className={`text-2xl font-extrabold ${p.totalScore >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {p.totalScore > 0 ? `+${p.totalScore}` : p.totalScore}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <h2 className="text-2xl font-bold text-center text-gray-700 mb-6 border-b pb-2">üìã Chi Ti·∫øt C√°c Phi√™n</h2>
                    
                    {/* DANH S√ÅCH CHI TI·∫æT C√ÅC PHI√äN */}
                    <div className="space-y-8">
                        {sessions.map((session, index) => {
                            
                            const sortedFinalResults = session.finalResults ? session.finalResults.sort((a, b) => b.score - a.score) : [];
                            
                            let gameStatus = 'Kh√¥ng r√µ';
                            if (session.roundsPlayed > 0) {
                                if (session.totalRoundsSet === null || session.roundsPlayed >= session.totalRoundsSet) {
                                    gameStatus = 'Ho√†n th√†nh';
                                } else {
                                    gameStatus = 'K·∫øt th√∫c s·ªõm';
                                }
                            } else if (session.finalResults && session.finalResults.length > 0) {
                                gameStatus = 'T√≠nh ti·ªÅn ngay';
                            }

                            return (
                                <div key={index} className="border border-gray-300 rounded-xl p-5 bg-white shadow-xl hover:shadow-2xl transition duration-200">
                                    <div className="flex justify-between items-center mb-3 border-b pb-3">
                                        <h2 className="text-xl font-bold text-gray-800">
                                            Phi√™n #{sessions.length - index}
                                        </h2>
                                        <div className="flex flex-col items-end">
                                            <span className={`text-sm font-bold px-3 py-1 rounded-full ${gameStatus === 'Ho√†n th√†nh' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                {session.roundsPlayed} V√°n ({gameStatus})
                                            </span>
                                            <p className="text-xs text-gray-500 mt-1">
                                                üóìÔ∏è <span className="font-medium">{formatSessionDate(session.timestamp)}</span>
                                            </p>
                                        </div>
                                    </div>
                                    
                                    {/* Danh s√°ch ng∆∞·ªùi ch∆°i v√† ƒëi·ªÉm cu·ªëi */}
                                    <div className="mt-2 space-y-1 text-base pt-2"> 
                                        {
                                            sortedFinalResults
                                                .map(p => (
                                                <div key={p.name} className="flex justify-between items-center">
                                                    
                                                    <div className={`history-player-name ${p.status === 'Kicked' ? 'text-gray-500 italic text-sm' : 'text-gray-800 text-base'}`}>
                                                        {p.name} {p.status === 'Kicked' && <span>(D·ª´ng)</span>}
                                                    </div>
                                                    
                                                    {/* C·ªòT 2: ƒêi·ªÉm cu·ªëi */}
                                                    <span className={`final-score ${p.score >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                        {p.score > 0 ? `+${p.score}` : p.score}
                                                    </span>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="text-center mt-8">
                        <a href="index.html" className="inline-block bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition shadow-lg text-lg">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<HistoryApp />);
    </script>
</body>
</html>
