<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ BXH T·ªïng H·ª£p</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .final-score { 
            display: inline-block; width: 60px; text-align: right; font-weight: 700; flex-shrink: 0;
        }
        .history-player-name { 
            font-weight: 700; color: #1f2937; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f3f4f6;
        }
        #root { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        /* Custom Select */
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3csvg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
            padding-right: 2.5rem; -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

	<script type="text/babel">
			const { useState, useEffect, useMemo } = React;

			// --- C·∫§U H√åNH GITHUB ---
			const REPO_OWNER = 'duphan97';
			const REPO_NAME = '9cay';
			const DATA_FILE_PATH = 'data/session_history.json'; 
			const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
			// --- END C·∫§U H√åNH GITHUB ---

			const b64ToUnicode = (str) => decodeURIComponent(
				Array.prototype.map.call(atob(str), (c) => 
					'%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
				).join('')
			);

			// --- H√ÄM H·ªñ TR·ª¢ NG√ÄY TH√ÅNG ---
			const getCurrentMonthKey = () => {
				const now = new Date();
				const month = now.getMonth() + 1;
				return `${now.getFullYear()}-${month.toString().padStart(2, '0')}`;
			};

			const getSessionMonthKey = (session) => {
				// FIX: ∆Øu ti√™n endTime, sau ƒë√≥ l√† timestamp, cu·ªëi c√πng l√† date
				const timeStr = session.endTime || session.timestamp || session.date; 
				
				if (!timeStr) return 'UNKNOWN'; // Tr·∫£ v·ªÅ Unknown n·∫øu kh√¥ng t√¨m th·∫•y b·∫•t k·ª≥ tr∆∞·ªùng n√†o
				try {
					const d = new Date(timeStr);
					if (isNaN(d.getTime())) return 'UNKNOWN';
					const month = d.getMonth() + 1;
					return `${d.getFullYear()}-${month.toString().padStart(2, '0')}`;
				} catch (e) {
					return 'UNKNOWN';
				}
			};

			const formatMonthDisplay = (key) => {
				if (key === 'ALL') return 'üìÖ T·∫•t c·∫£ th·ªùi gian (All-Time)';
				if (key === 'UNKNOWN') return '‚ùì Kh√¥ng x√°c ƒë·ªãnh th·ªùi gian';
				const [year, month] = key.split('-');
				return `üóìÔ∏è Th√°ng ${month}/${year}`;
			};

			const fetchHistoryFromGitHub = async () => {
				const response = await fetch(GITHUB_API_URL, {
					method: 'GET', headers: { 'Accept': 'application/vnd.github.v3+json' },
				});
				if (response.status === 404) return [];
				if (!response.ok) throw new Error(`L·ªói t·∫£i: ${response.statusText}`);
				const fileData = await response.json();
				try {
					return JSON.parse(b64ToUnicode(fileData.content));
				} catch (e) { throw new Error("D·ªØ li·ªáu JSON h·ªèng."); }
			};

			// --- LOGIC T√çNH ƒêI·ªÇM (ƒê√£ s·ª≠a l·ªói √©p ki·ªÉu s·ªë) ---
			const calculateScores = (sessions) => {
				if (!sessions || sessions.length === 0) return [];
				
				const scoresMap = {};
				sessions.forEach(session => {
					if (Array.isArray(session.finalResults)) {
						session.finalResults.forEach(player => {
							const { name, score } = player;
							// ƒê·∫£m b·∫£o score l√† s·ªë nguy√™n
							const safeScore = parseInt(score, 10) || 0; 
							scoresMap[name] = (scoresMap[name] || 0) + safeScore;
						});
					}
				});

				return Object.keys(scoresMap).map(name => ({
					name,
					totalScore: scoresMap[name]
				})).sort((a, b) => b.totalScore - a.totalScore); 
			};


			function HistoryApp() {
				const [sessions, setSessions] = useState(null);
				const [loading, setLoading] = useState(true); 
				const [loadError, setLoadError] = useState(null); 
				
				const [filterType, setFilterType] = useState('ALL');

				useEffect(() => {
					const loadHistory = async () => {
						setLoading(true);
						try {
							const data = await fetchHistoryFromGitHub();
							setSessions(data);
						} catch (err) {
							console.error(err);
							setLoadError("L·ªói k·∫øt n·ªëi ho·∫∑c d·ªØ li·ªáu h·ªèng."); 
						} finally {
							setLoading(false);
						}
					};
					loadHistory();
				}, []);

				// --- LOGIC T·ª∞ ƒê·ªòNG CH·ªåN TH√ÅNG TH√îNG MINH ---
				useEffect(() => {
					if (sessions && sessions.length > 0 && filterType === 'ALL') { // Ch·ªâ ch·∫°y 1 l·∫ßn l√∫c ƒë·∫ßu n·∫øu filterType ƒëang l√† 'ALL'
						const currentMonthKey = getCurrentMonthKey();
						
						const monthsInData = new Set();
						sessions.forEach(s => {
                            const key = getSessionMonthKey(s);
                            if(key !== 'UNKNOWN') monthsInData.add(key);
                        });
                        
                        const availableMonthsList = Array.from(monthsInData).sort().reverse();

						if (monthsInData.has(currentMonthKey)) {
							// ∆Øu ti√™n 1: Th√°ng hi·ªán t·∫°i c√≥ d·ªØ li·ªáu -> Ch·ªçn n√≥
							setFilterType(currentMonthKey);
						} else if (availableMonthsList.length > 0) {
							// ∆Øu ti√™n 2: Th√°ng hi·ªán t·∫°i TR·ªêNG -> Ch·ªçn th√°ng M·ªöI NH·∫§T c√≥ d·ªØ li·ªáu
							setFilterType(availableMonthsList[0]);
						} else {
							// Fallback: Kh√¥ng c√≥ ng√†y th√°ng h·ª£p l·ªá -> Ch·ªçn ALL
							setFilterType('ALL');
						}
					}
				}, [sessions]);

				// L·∫•y danh s√°ch options cho Dropdown
				const availableMonths = useMemo(() => {
					if (!sessions) return [];
					const monthsSet = new Set();
					sessions.forEach(s => monthsSet.add(getSessionMonthKey(s)));
					// S·∫Øp x·∫øp: Unknown xu·ªëng cu·ªëi, c√≤n l·∫°i gi·∫£m d·∫ßn theo ng√†y
					return Array.from(monthsSet).sort((a, b) => {
						if (a === 'UNKNOWN') return 1;
						if (b === 'UNKNOWN') return -1;
						return b.localeCompare(a);
					});
				}, [sessions]);

				// L·ªçc d·ªØ li·ªáu
				const filteredSessions = useMemo(() => {
					if (!sessions) return [];
					if (filterType === 'ALL') return sessions;
					return sessions.filter(s => getSessionMonthKey(s) === filterType);
				}, [sessions, filterType]);

				// T√≠nh to√°n BXH
				const leaderboard = useMemo(() => calculateScores(filteredSessions), [filteredSessions]);

				// Render
				if (loading) return (
					<div className="text-center p-8 mt-10"><div className="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-500 mx-auto"></div><p className="mt-4 text-blue-600 font-semibold">ƒêang t·ªïng h·ª£p s·ªë li·ªáu...</p></div>
				);

				if (loadError && !sessions) return (
					<div className="text-center p-8 bg-red-100 border border-red-400 rounded-xl mt-10"><p className="text-red-700 font-bold">‚ùå {loadError}</p><button onClick={() => window.location.reload()} className="mt-4 bg-purple-600 text-white px-4 py-2 rounded">Th·ª≠ l·∫°i</button></div>
				);

				return (
					<div>
						<h1 className="text-2xl md:text-3xl font-extrabold text-center text-purple-700 mb-6 mt-4">
                            {filterType === 'ALL' ? 'üèÜ BXH T·ªïng S·∫Øp' : `üèÜ BXH ${formatMonthDisplay(filterType).replace('üóìÔ∏è ', '')}`}
                        </h1>

                        {/* THANH ƒêI·ªÄU KHI·ªÇN / B·ªò L·ªåC */}
                        <div className="flex justify-center mb-6">
                            <div className="w-full max-w-sm px-4">
                                <label className="block text-gray-600 text-xs font-bold mb-1 uppercase text-center tracking-wide">
                                    Ch·ªçn m·ªëc th·ªùi gian
                                </label>
                                <div className="relative">
                                    <select 
                                        value={filterType} 
                                        onChange={(e) => setFilterType(e.target.value)}
                                        className="custom-select block w-full bg-white border-2 border-blue-200 hover:border-blue-400 px-4 py-3 rounded-xl shadow-sm leading-tight focus:outline-none focus:border-blue-500 text-gray-800 font-bold text-lg transition-colors cursor-pointer"
                                    >
                                        <option value="ALL">üåü T·∫•t c·∫£ th·ªùi gian (T·ªïng)</option>
                                        <optgroup label="Chi ti·∫øt theo th√°ng">
                                            {availableMonths.map(monthKey => (
                                                <option key={monthKey} value={monthKey}>
                                                    {formatMonthDisplay(monthKey)}
                                                </option>
                                            ))}
                                        </optgroup>
                                    </select>
                                </div>
                                <p className="text-center text-gray-400 text-xs mt-2 italic">
                                    *H·ªá th·ªëng t·ª± ƒë·ªông hi·ªÉn th·ªã th√°ng g·∫ßn nh·∫•t c√≥ d·ªØ li·ªáu
                                </p>
                            </div>
                        </div>
						
						{/* HI·ªÇN TH·ªä BXH */}
                        {leaderboard.length === 0 ? (
                             <div className="text-center p-10 bg-white border-2 border-dashed border-gray-300 rounded-xl mx-4">
                                <p className="font-bold text-gray-400 text-xl">üì≠ Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                                <p className="text-gray-400 mt-2 text-sm">Kh√¥ng t√¨m th·∫•y v√°n ch∆°i n√†o trong kho·∫£ng th·ªùi gian n√†y.</p>
                                <button onClick={() => setFilterType('ALL')} className="mt-4 text-blue-500 hover:underline font-semibold">Xem t·∫•t c·∫£ th·ªùi gian</button>
                            </div>
                        ) : (
                            <div className="mb-10 mx-auto max-w-2xl bg-white border border-gray-200 rounded-2xl shadow-lg overflow-hidden">
                                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-5 py-4 border-b border-gray-200 flex justify-between items-center">
                                    <div>
                                        <h2 className="text-lg font-bold text-gray-800 uppercase tracking-tight">B·∫£ng X·∫øp H·∫°ng</h2>
                                        <p className="text-xs text-gray-500 font-medium mt-0.5">D·ª±a tr√™n {filteredSessions.length} phi√™n ch∆°i</p>
                                    </div>
                                    <div className="h-10 w-10 bg-yellow-400 rounded-full flex items-center justify-center shadow-inner text-xl">üëë</div>
                                </div>
                                
                                <div className="divide-y divide-gray-100">
                                    {leaderboard.map((p, index) => (
                                        <div key={p.name} className={`flex justify-between items-center p-4 hover:bg-gray-50 transition-colors ${index < 3 ? 'bg-yellow-50/50' : ''}`}>
                                            <div className="flex items-center flex-grow overflow-hidden mr-4">
                                                <div className={`w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full mr-3 font-bold text-sm ${
                                                    index === 0 ? 'bg-yellow-400 text-yellow-900 shadow-sm' :
                                                    index === 1 ? 'bg-gray-300 text-gray-800 shadow-sm' :
                                                    index === 2 ? 'bg-orange-300 text-orange-900 shadow-sm' :
                                                    'bg-gray-100 text-gray-500'
                                                }`}>
                                                    {index + 1}
                                                </div>
                                                <span className={`truncate text-lg ${index < 3 ? 'font-bold text-gray-900' : 'font-medium text-gray-700'}`}>
                                                    {p.name}
                                                </span>
                                            </div>
                                            
                                            <div className={`text-xl font-bold font-mono tracking-tight ${p.totalScore > 0 ? 'text-green-600' : p.totalScore < 0 ? 'text-red-500' : 'text-gray-400'}`}>
                                                {p.totalScore > 0 ? `+${p.totalScore}` : p.totalScore}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

						<div className="text-center pb-10">
							<a href="index.html" className="inline-flex items-center bg-gray-800 text-white px-6 py-3 rounded-full font-bold hover:bg-gray-900 transition shadow-lg text-sm uppercase tracking-wider transform hover:-translate-y-0.5">
								<span className="mr-2">‚¨ÖÔ∏è</span> Quay l·∫°i b√†n ch∆°i
							</a>
						</div>
					</div>
				);
			}

			const root = ReactDOM.createRoot(document.getElementById("root"));
			root.render(<HistoryApp />);
		</script>
</body>
</html>v
