<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí L·ªãch S·ª≠ T·ªïng H·ª£p & BXH</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div id="root" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- C·∫§U H√åNH GITHUB (V·∫™N C·∫¶N CHO CH·ª®C NƒÇNG L∆ØU KH√îNG M·∫¨T KH·∫®U, nh∆∞ng s·∫Ω d√πng Netlify Function ƒë·ªÉ T·∫¢I) ---
        // V·∫´n gi·ªØ l·∫°i ƒë·ªÉ ti·ªán tham kh·∫£o/debug
        const GITHUB_USERNAME = "duphan97"; 
        const REPO_NAME = "9cay"; 
        // --- END C·∫§U H√åNH GITHUB ---

        // URL c·ªßa Netlify Function
        const AUTH_URL = '/.netlify/functions/authenticate';
        const HISTORY_API_URL = '/.netlify/functions/get-history'; 

        // H√†m T·∫£i l·ªãch s·ª≠ v·ªõi token
        const fetchHistoryWithToken = async (token) => {
            const response = await fetch(HISTORY_API_URL, {
                headers: {
                    'X-Auth-Token': token
                }
            });
            
            if (response.status === 401) {
                // X√≥a token n·∫øu b·ªã t·ª´ ch·ªëi
                localStorage.removeItem('historyToken');
                localStorage.removeItem('tokenExpiry');
                throw new Error("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p l·∫°i m·∫≠t kh·∫©u.");
            }
            if (!response.ok) {
                throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu: ${response.statusText}`);
            }
            
            const data = await response.json();
            // ƒê·∫£o ng∆∞·ª£c ƒë·ªÉ phi√™n m·ªõi nh·∫•t l√™n ƒë·∫ßu
            return data.reverse(); 
        };

        // H√†m t√≠nh t·ªïng ƒëi·ªÉm to√†n th·ªùi gian (All-Time Score)
        const calculateAllTimeScores = (sessions) => {
            if (!sessions || sessions.length === 0) return [];
            
            const scoresMap = {};

            sessions.forEach(session => {
                session.finalResults.forEach(player => {
                    const { name, score } = player;
                    scoresMap[name] = (scoresMap[name] || 0) + score;
                });
            });

            const scoreboard = Object.keys(scoresMap).map(name => ({
                name,
                totalScore: scoresMap[name]
            })).sort((a, b) => b.totalScore - a.totalScore); 

            return scoreboard;
        };

        // Helper cho hi·ªÉn th·ªã th·ªùi gian
        const formatSessionDate = (isoString) => {
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return isoString ? isoString.substring(0, 10) : 'N/A';
            }
        };


        function HistoryApp() {
            const [sessions, setSessions] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Tr·∫°ng th√°i x√°c th·ª±c
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState(null);
            const [isAuthenticating, setIsAuthenticating] = useState(false);


            // 1. Ki·ªÉm tra Token v√† T·∫£i l·ªãch s·ª≠
            useEffect(() => {
                const token = localStorage.getItem('historyToken');
                const expiry = localStorage.getItem('tokenExpiry');
                
                // Ki·ªÉm tra token c√≥ t·ªìn t·∫°i v√† ch∆∞a h·∫øt h·∫°n kh√¥ng
                if (token && expiry && Date.now() < parseInt(expiry)) {
                    setIsAuthenticated(true);
                    setLoading(true);
                    fetchHistoryWithToken(token)
                        .then(data => {
                            setSessions(data);
                            setError(null);
                        })
                        .catch(err => {
                            console.error("L·ªói t·∫£i l·ªãch s·ª≠ v·ªõi token:", err.message);
                            // Bu·ªôc ƒëƒÉng xu·∫•t n·∫øu token kh√¥ng d√πng ƒë∆∞·ª£c
                            setIsAuthenticated(false);
                            localStorage.removeItem('historyToken');
                            localStorage.removeItem('tokenExpiry');
                            setAuthError(err.message);
                            setError(null); // X√≥a l·ªói t·∫£i (chuy·ªÉn th√†nh l·ªói auth)
                        })
                        .finally(() => setLoading(false));
                } else {
                    setLoading(false);
                }
            }, [isAuthenticated]); // Ph·ª• thu·ªôc v√†o isAuthenticated ƒë·ªÉ re-trigger sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng

            // 2. Logic ƒêƒÉng nh·∫≠p (Authentication)
            const handleLogin = async (e) => {
                e.preventDefault();
                setIsAuthenticating(true);
                setAuthError(null);
                
                try {
                    const response = await fetch(AUTH_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ password }),
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        setAuthError(result.message || 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.');
                        setIsAuthenticated(false);
                    } else {
                        // L∆∞u token v√† th·ªùi gian h·∫øt h·∫°n
                        localStorage.setItem('historyToken', result.token);
                        localStorage.setItem('tokenExpiry', result.expiry);
                        
                        setPassword(''); // X√≥a m·∫≠t kh·∫©u
                        setIsAuthenticated(true); // K√≠ch ho·∫°t useEffect ƒë·ªÉ t·∫£i d·ªØ li·ªáu
                    }
                } catch (err) {
                    setAuthError('L·ªói k·∫øt n·ªëi server. Ki·ªÉm tra Netlify Function.');
                } finally {
                    setIsAuthenticating(false);
                }
            };

            const allTimeScores = useMemo(() => calculateAllTimeScores(sessions), [sessions]);

            // --- Giao di·ªán Form ƒêƒÉng nh·∫≠p ---
            if (!isAuthenticated) {
                return (
                    <div className="text-center p-8">
                        <h1 className="text-3xl font-bold text-red-600 mb-6">üîí Truy C·∫≠p L·ªãch S·ª≠ B·∫£o M·∫≠t</h1>
                        <form onSubmit={handleLogin} className="max-w-xs mx-auto space-y-4">
                            <input
                                type="password"
                                className="w-full border-2 border-gray-300 p-3 rounded-lg text-lg focus:outline-none focus:border-blue-500"
                                placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                disabled={isAuthenticating}
                                required
                            />
                            <button
                                type="submit"
                                className={`w-full py-3 rounded-lg text-white font-bold transition ${
                                    isAuthenticating || !password 
                                        ? 'bg-gray-400 cursor-not-allowed' 
                                        : 'bg-blue-600 hover:bg-blue-700'
                                }`}
                                disabled={isAuthenticating || !password}
                            >
                                {isAuthenticating ? 'ƒêang x√°c th·ª±c...' : 'M·ªü kh√≥a L·ªãch s·ª≠'}
                            </button>
                            {authError && (
                                <p className="text-red-500 font-medium text-sm pt-2">{authError}</p>
                            )}
                        </form>
                    </div>
                );
            }
            
            // --- Giao di·ªán L·ªãch s·ª≠ (Sau khi ƒëƒÉng nh·∫≠p) ---
            
            if (loading) {
                return (
                    <div className="text-center p-8">
                        <p className="font-semibold mb-4 text-blue-600">ƒêang t·∫£i l·ªãch s·ª≠ t·ªïng h·ª£p...</p>
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto"></div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="text-center p-8 bg-red-100 border border-red-400 rounded-lg">
                        <p className="font-bold text-red-600 mb-2">‚ùå L·ªói T·∫£i L·ªãch S·ª≠</p>
                        <p className="text-sm text-gray-700">{error}</p>
                    </div>
                );
            }

            if (!sessions || sessions.length === 0) {
                return (
                    <div className="text-center p-8 bg-yellow-100 border border-yellow-400 rounded-lg">
                        <p className="font-bold text-yellow-700">üìú Ch∆∞a C√≥ D·ªØ Li·ªáu L·ªãch S·ª≠</p>
                        <p className="text-sm text-gray-600 mt-2">H√£y ho√†n th√†nh m·ªôt phi√™n ch∆°i ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông l∆∞u.</p>
                        <a href="index.html" className="inline-block bg-blue-500 text-white px-4 py-2 rounded font-bold hover:bg-blue-600 transition mt-4">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                );
            }

            return (
                <div>
                    <h1 className="text-3xl font-bold text-center text-purple-600 mb-6">üìú L·ªãch S·ª≠ & B·∫£ng X·∫øp H·∫°ng T·ªïng H·ª£p ({sessions.length} Phi√™n)</h1>
                    
                    {/* B·∫¢NG X·∫æP H·∫†NG T·ªîNG ƒêI·ªÇM TO√ÄN TH·ªúI GIAN */}
                    <div className="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg shadow-md">
                        <h2 className="text-xl font-bold text-blue-800 mb-3 text-center">üèÜ B·∫£ng X·∫øp H·∫°ng T·ªïng ƒêi·ªÉm To√†n Th·ªùi Gian</h2>
                        <div className="space-y-2">
                            {allTimeScores.map((p, index) => (
                                <div key={p.name} className={`flex justify-between items-center p-2 rounded ${index < 3 ? 'bg-yellow-100 font-extrabold border-l-4 border-yellow-500' : 'bg-white border'}`}>
                                    <span className="text-lg">
                                        {index === 0 && 'ü•á'}
                                        {index === 1 && 'ü•à'}
                                        {index === 2 && 'ü•â'}
                                        {index >= 3 && `${index + 1}. `}
                                        {p.name}
                                    </span>
                                    <span className={`text-xl font-bold ${p.totalScore >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {p.totalScore > 0 ? `+${p.totalScore}` : p.totalScore}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <h2 className="text-2xl font-bold text-center text-gray-700 mb-4 border-b pb-2">üìã Chi Ti·∫øt C√°c Phi√™n</h2>
                    
                    {/* DANH S√ÅCH CHI TI·∫æT C√ÅC PHI√äN */}
                    <div className="space-y-6">
                        {sessions.map((session, index) => {
                            
                            // S·∫Øp x·∫øp ng∆∞·ªùi ch∆°i theo ƒëi·ªÉm s·ªë cu·ªëi c√πng
                            const sortedFinalResults = session.finalResults.sort((a, b) => b.score - a.score);

                            return (
                                <div key={index} className="border border-gray-300 rounded-xl p-4 bg-white shadow-md hover:shadow-lg transition">
                                    <div className="flex justify-between items-center mb-2 border-b pb-2">
                                        <h2 className="text-lg font-bold text-gray-800">
                                            Phi√™n #{sessions.length - index}
                                        </h2>
                                        <span className={`text-sm font-bold px-3 py-1 rounded-full ${session.gameStatus === 'COMPLETED' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                            {session.roundsPlayed} V√°n ({session.gameStatus === 'COMPLETED' ? 'Ho√†n th√†nh' : 'Reset gi·ªØa ch·ª´ng'})
                                        </span>
                                    </div>
                                    
                                    <p className="text-sm text-gray-600 mb-3">
                                        üóìÔ∏è <span className="font-medium">{formatSessionDate(session.timestamp)}</span>
                                    </p>
                                    
                                    {/* Danh s√°ch ng∆∞·ªùi ch∆°i v√† ƒëi·ªÉm cu·ªëi */}
                                    <div className="mt-2 space-y-1 text-sm pt-2 border-t"> 
                                        {
                                            sortedFinalResults
                                                .map(p => (
                                                <div key={p.name} className="flex justify-between">
                                                    <span className={`font-medium ${p.status === 'Kicked' ? 'text-gray-500 italic text-xs' : 'text-gray-800'}`}>
                                                        {p.name} {p.status === 'Kicked' && '(D·ª´ng)'}
                                                    </span>
                                                    <span className={`font-bold ${p.score >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                        {p.score > 0 ? `+${p.score}` : p.score}
                                                    </span>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="text-center mt-6">
                        <a href="index.html" className="inline-block bg-blue-500 text-white px-4 py-2 rounded font-bold hover:bg-blue-600 transition">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                        <button onClick={() => {
                            localStorage.removeItem('historyToken');
                            localStorage.removeItem('tokenExpiry');
                            setIsAuthenticated(false);
                            setSessions(null);
                        }} className="ml-4 bg-red-500 text-white px-4 py-2 rounded font-bold hover:bg-red-600 transition">
                            üîì ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<HistoryApp />);
    </script>
</body>
</html>
