<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìú L·ªãch S·ª≠ Phi√™n Ch∆°i T·ªïng H·ª£p</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div id="root" class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- C·∫§U H√åNH GITHUB (B·∫ÆT BU·ªòC PH·∫¢I THAY TH·∫æ) ---
        const GITHUB_USERNAME = "duphan97"; 
        const REPO_NAME = "9cay"; 
        const HISTORY_FILE_PATH = "sessions/game_sessions.json";
        // URL c√¥ng khai ƒë·ªÉ T·∫¢I file JSON
        const PUBLIC_HISTORY_URL = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/main/${HISTORY_FILE_PATH}`;
        // --- END C·∫§U H√åNH GITHUB ---

        function HistoryApp() {
            const [sessions, setSessions] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // Helper cho hi·ªÉn th·ªã th·ªùi gian
            const formatSessionDate = (isoString) => {
                try {
                    const date = new Date(isoString);
                    return date.toLocaleDateString('vi-VN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch {
                    return isoString ? isoString.substring(0, 10) : 'N/A';
                }
            };
            
            // H√†m t√≠nh ng∆∞·ªùi c√≥ ƒëi·ªÉm s·ªë cao nh·∫•t (winner) c·ªßa phi√™n
            const getSessionWinner = (players, kickedPlayers) => {
                const allPlayers = [...players, ...kickedPlayers];
                if (allPlayers.length === 0) return { name: "N/A", score: 0 };
                
                // S·∫Øp x·∫øp theo ƒëi·ªÉm s·ªë gi·∫£m d·∫ßn
                allPlayers.sort((a, b) => b.score - a.score);
                
                const topScore = allPlayers[0].score;
                // L·∫•y t·∫•t c·∫£ ng∆∞·ªùi ch∆°i c√≥ ƒëi·ªÉm s·ªë cao nh·∫•t (c√≥ th·ªÉ h√≤a)
                const winners = allPlayers.filter(p => p.score === topScore);
                
                if (winners.length === 1) {
                    return { name: winners[0].name, score: topScore };
                } else if (winners.length > 1) {
                    return { name: winners.map(w => w.name).join(' & '), score: topScore, isTie: true };
                }
                return { name: "N/A", score: 0 };
            };


            useEffect(() => {
                if (GITHUB_USERNAME === "YOUR_GITHUB_USERNAME" || REPO_NAME === "YOUR_REPO_NAME") {
                    setError("L·ªói c·∫•u h√¨nh: Vui l√≤ng thay th·∫ø YOUR_GITHUB_USERNAME v√† YOUR_REPO_NAME trong file history.html!");
                    setLoading(false);
                    return;
                }
                
                const fetchHistory = async () => {
                    setLoading(true);
                    setError(null);
                    try {
                        const response = await fetch(PUBLIC_HISTORY_URL);
                        if (!response.ok) {
                            if (response.status === 404) {
                                setError("Ch∆∞a c√≥ l·ªãch s·ª≠ t·ªïng h·ª£p n√†o ƒë∆∞·ª£c l∆∞u tr√™n GitHub (File 404). H√£y ho√†n th√†nh 1 game ƒë·ªÉ t·ª± ƒë·ªông l∆∞u.");
                                return;
                            }
                            throw new Error(`L·ªói HTTP: ${response.status}`);
                        }
                        const data = await response.json();
                        setSessions(data.reverse()); // ƒê·∫£o ng∆∞·ª£c ƒë·ªÉ phi√™n m·ªõi nh·∫•t l√™n ƒë·∫ßu
                    } catch (err) {
                        console.error("L·ªói khi t·∫£i l·ªãch s·ª≠:", err);
                        setError(`L·ªói khi t·∫£i l·ªãch s·ª≠: ${err.message}. Ki·ªÉm tra Console.`);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchHistory();
            }, []);

            if (loading) {
                return (
                    <div className="text-center p-8">
                        <p className="font-semibold mb-4 text-blue-600">ƒêang t·∫£i l·ªãch s·ª≠ t·ªïng h·ª£p...</p>
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto"></div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="text-center p-8 bg-red-100 border border-red-400 rounded-lg">
                        <p className="font-bold text-red-600 mb-2">‚ùå L·ªói T·∫£i L·ªãch S·ª≠</p>
                        <p className="text-sm text-gray-700">{error}</p>
                    </div>
                );
            }

            if (!sessions || sessions.length === 0) {
                return (
                    <div className="text-center p-8 bg-yellow-100 border border-yellow-400 rounded-lg">
                        <p className="font-bold text-yellow-700">üìú Ch∆∞a C√≥ D·ªØ Li·ªáu L·ªãch S·ª≠</p>
                        <p className="text-sm text-gray-600 mt-2">H√£y ho√†n th√†nh m·ªôt phi√™n ch∆°i (ƒë·∫øn h·∫øt s·ªë v√°n ƒë·∫∑t ra) ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông l∆∞u.</p>
                    </div>
                );
            }

            return (
                <div>
                    <h1 className="text-3xl font-bold text-center text-purple-600 mb-6">üìú L·ªãch S·ª≠ C√°c Phi√™n Ch∆°i ({sessions.length})</h1>
                    <div className="space-y-6">
                        {sessions.map((session, index) => {
                            const sessionWinner = getSessionWinner(session.finalPlayers, session.kickedPlayers);
                            
                            return (
                                <div key={index} className="border border-gray-300 rounded-xl p-4 bg-white shadow-md hover:shadow-lg transition">
                                    <div className="flex justify-between items-center mb-2 border-b pb-2">
                                        <h2 className="text-lg font-bold text-gray-800">
                                            Phi√™n #{sessions.length - index}
                                        </h2>
                                        <span className={`text-sm font-bold px-3 py-1 rounded-full ${session.gameStatus === 'COMPLETED' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                            {session.roundsPlayed} V√°n
                                        </span>
                                    </div>
                                    
                                    <p className="text-sm text-gray-600 mb-3">
                                        üóìÔ∏è <span className="font-medium">{formatSessionDate(session.timestamp)}</span>
                                    </p>
                                    
                                    <div className={`p-3 rounded-lg border-2 ${sessionWinner.isTie ? 'bg-yellow-100 border-yellow-400' : 'bg-green-100 border-green-400'}`}>
                                        <p className="font-bold text-md flex justify-between">
                                            Ng∆∞·ªùi Th·∫Øng: 
                                            <span className={sessionWinner.isTie ? 'text-yellow-800' : 'text-green-800'}>
                                                {sessionWinner.name}
                                            </span>
                                        </p>
                                        <p className="font-bold text-md flex justify-between">
                                            ƒêi·ªÉm Cu·ªëi: 
                                            <span className={sessionWinner.score >= 0 ? 'text-green-800' : 'text-red-800'}>
                                                {sessionWinner.score > 0 ? `+${sessionWinner.score}` : sessionWinner.score}
                                            </span>
                                        </p>
                                    </div>
                                    
                                    <h3 className="text-md font-semibold mt-3 mb-1 text-gray-700">Chi ti·∫øt ƒëi·ªÉm cu·ªëi:</h3>
                                    <div className="space-y-1 text-sm">
                                        {/* Hi·ªÉn th·ªã T√≥m t·∫Øt ƒëi·ªÉm cu·ªëi */}
                                        {
                                            [...session.finalPlayers, ...session.kickedPlayers]
                                                .sort((a, b) => b.score - a.score)
                                                .map(p => (
                                                <div key={p.name} className="flex justify-between border-b border-gray-100 pb-0.5">
                                                    <span className={`font-medium ${session.kickedPlayers.some(k => k.name === p.name) ? 'text-gray-500 italic text-xs' : 'text-gray-800'}`}>
                                                        {p.name} {session.kickedPlayers.some(k => k.name === p.name) && '(D·ª´ng)'}
                                                    </span>
                                                    <span className={`font-bold ${p.score >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                        {p.score > 0 ? `+${p.score}` : p.score}
                                                    </span>
                                                </div>
                                            ))
                                        }
                                    </div>

                                    {/* N√∫t xem chi ti·∫øt v√°n ch∆°i (T√πy ch·ªçn) */}
                                    {/* <details className="mt-3">
                                        <summary className="cursor-pointer text-blue-500 hover:text-blue-700 font-medium text-sm">Xem chi ti·∫øt t·ª´ng v√°n</summary>
                                        <ul className="text-xs mt-2 space-y-1 bg-blue-50 p-2 rounded">
                                            {session.detailedHistory.map((round, rIndex) => (
                                                <li key={rIndex} className="border-b border-blue-200 pb-1">
                                                    <strong>V√°n {round.round}:</strong> Th·∫Øng: {round.winner} ({round.isDouble ? 'Double' : 'Th∆∞·ªùng'})
                                                </li>
                                            ))}
                                        </ul>
                                    </details> */}
                                </div>
                            );
                        })}
                    </div>
                    <div className="text-center mt-6">
                        <a href="index.html" class="inline-block bg-blue-500 text-white px-4 py-2 rounded font-bold hover:bg-blue-600 transition">
                            ‚Ü©Ô∏è Quay l·∫°i Game
                        </a>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<HistoryApp />);
    </script>
</body>
</html>