<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† BXH Tá»•ng Há»£p</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Má»šI: CÄƒn chá»‰nh hiá»ƒn thá»‹ lá»‹ch sá»­ chi tiáº¿t */
        
        /* Cá»‘ Ä‘á»‹nh chiá»u rá»™ng cho Ä‘iá»ƒm Ä‘á»ƒ cÄƒn Ä‘á»u tuyá»‡t Ä‘á»‘i (Váº«n giá»¯ Ä‘á»ƒ score trong BXH cÄƒn Ä‘á»u) */
        .final-score { 
            display: inline-block;
            width: 60px; /* Äá»™ rá»™ng cá»‘ Ä‘á»‹nh, Ä‘á»§ cho "+999" */
            text-align: right;
            font-weight: 700; /* in Ä‘áº­m */
            flex-shrink: 0; /* KhÃ´ng cho phÃ©p bá»‹ co láº¡i */
        }
        
        /* TÃªn ngÆ°á»i chÆ¡i trong lá»‹ch sá»­ (Váº«n giá»¯ Ä‘á»ƒ tÃªn trong BXH hiá»ƒn thá»‹ tá»‘t) */
        .history-player-name { 
            font-weight: 700; 
            color: #1f2937; 
            flex-grow: 1; 
            white-space: nowrap; /* NgÄƒn tÃªn bá»‹ xuá»‘ng dÃ²ng */
            overflow: hidden; /* áº¨n pháº§n bá»‹ trÃ n */
            text-overflow: ellipsis; /* Hiá»ƒn thá»‹ dáº¥u ba cháº¥m */
        }
        
        /* Äáº£m báº£o toÃ n bá»™ á»©ng dá»¥ng sá»­ dá»¥ng font-sans */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f3f4f6; /* MÃ u ná»n nháº¹ */
        }
        
        /* CÄƒn giá»¯a ná»™i dung chÃ­nh */
        #root {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

	<script type="text/babel">
			const { useState, useEffect, useMemo } = React;

			// --- Cáº¤U HÃŒNH GITHUB ---
			const REPO_OWNER = 'duphan97';
			const REPO_NAME = '9cay';
			const DATA_FILE_PATH = 'data/session_history.json'; 
			const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
			// --- END Cáº¤U HÃŒNH GITHUB ---

			// --- BASE64 AN TOÃ€N CHO UNICODE ---
			const b64ToUnicode = (str) => decodeURIComponent(
				Array.prototype.map.call(atob(str), (c) => 
					'%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
				).join('')
			);
			// --- END FIX ---


			// HÃ m Táº£i lá»‹ch sá»­ trá»±c tiáº¿p tá»« GitHub
			const fetchHistoryFromGitHub = async () => {
				const response = await fetch(GITHUB_API_URL, {
					method: 'GET',
					headers: {
						'Accept': 'application/vnd.github.v3+json', 
					},
				});

				if (response.status === 404) {
					return []; 
				}
				if (!response.ok) {
					throw new Error(`Lá»—i táº£i dá»¯ liá»‡u tá»« GitHub: ${response.statusText}`);
				}

				const fileData = await response.json();
				
				const encodedContent = fileData.content;
				let sessionsData;
				try {
					const jsonString = b64ToUnicode(encodedContent); 
					sessionsData = JSON.parse(jsonString);
				} catch (e) {
					console.error("Lá»—i Decode/Parse JSON:", e);
					throw new Error("Dá»¯ liá»‡u lá»‹ch sá»­ khÃ´ng há»£p lá»‡ (lá»—i Decode/JSON).");
				}
				
				return sessionsData; 
			};

			// HÃ m tÃ­nh tá»•ng Ä‘iá»ƒm toÃ n thá»i gian (All-Time Score)
			const calculateAllTimeScores = (sessions) => {
				if (!sessions || sessions.length === 0) return [];
				
				const scoresMap = {};

				sessions.forEach(session => {
					if (Array.isArray(session.finalResults)) {
						session.finalResults.forEach(player => {
							const { name, score } = player;
							scoresMap[name] = (scoresMap[name] || 0) + score;
						});
					}
				});

				const scoreboard = Object.keys(scoresMap).map(name => ({
					name,
					totalScore: scoresMap[name]
				})).sort((a, b) => b.totalScore - a.totalScore); 

				return scoreboard;
			};
            
			// ÄÃ£ loáº¡i bá» formatSessionDate vÃ¬ khÃ´ng cÃ²n dÃ¹ng Ä‘áº¿n


			function HistoryApp() {
				const [sessions, setSessions] = useState(null);
				const [loading, setLoading] = useState(true); 
				const [loadError, setLoadError] = useState(null); 

				// Tá»° Äá»˜NG Táº¢I Lá»ŠCH Sá»¬
				useEffect(() => {
					const loadHistory = async () => {
						setLoading(true);
						setLoadError(null);
						try {
							const data = await fetchHistoryFromGitHub();
							setSessions(data);
						} catch (err) {
							console.error("Lá»—i táº£i lá»‹ch sá»­:", err.message);
							setLoadError("Lá»—i khi táº£i dá»¯ liá»‡u lá»‹ch sá»­ tá»« GitHub. Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i máº¡ng."); 
						} finally {
							setLoading(false);
						}
					};

					loadHistory();
				}, []);

				const allTimeScores = useMemo(() => calculateAllTimeScores(sessions), [sessions]);

				
				// --- Giao diá»‡n Äang Táº£i ---
				if (loading) {
					return (
						<div className="text-center p-8 min-h-[50vh] flex flex-col justify-center items-center">
							<p className="font-semibold mb-4 text-blue-600 text-lg">Äang táº£i báº£ng xáº¿p háº¡ng...</p>
							<div className="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-500 mx-auto"></div>
						</div>
					);
				}

				// --- Giao diá»‡n Lá»—i Táº£i ---
				if (loadError && !sessions) { 
					return (
						<div className="text-center p-8 bg-red-100 border border-red-400 rounded-xl shadow-lg">
							<p className="font-bold text-red-700 mb-3 text-2xl">âŒ Lá»—i Táº£i Dá»¯ Liá»‡u</p>
							<p className="text-base text-gray-700">{loadError}</p>
							<button 
								onClick={() => window.location.reload()}
								className="inline-block bg-purple-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-purple-700 transition mt-4 shadow-md text-lg">
								ğŸ”„ Thá»­ láº¡i
							</button>
						</div>
					);
				}

				// --- Giao diá»‡n ChÆ°a CÃ³ Dá»¯ Liá»‡u ---
				if (!sessions || sessions.length === 0) {
					return (
						<div className="text-center p-8 bg-yellow-100 border border-yellow-400 rounded-xl shadow-lg">
							<p className="font-bold text-yellow-700 text-2xl">ğŸ† Báº£ng Xáº¿p Háº¡ng Trá»‘ng</p>
							<p className="text-base text-gray-600 mt-2">HÃ£y hoÃ n thÃ nh má»™t phiÃªn chÆ¡i Ä‘á»ƒ táº¡o báº£ng xáº¿p háº¡ng Ä‘áº§u tiÃªn.</p>
							<a href="index.html" className="inline-block bg-blue-500 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-600 transition mt-4 shadow-md text-lg">
								â†©ï¸ Quay láº¡i Game
							</a>
						</div>
					);
				}

				// --- Giao diá»‡n Báº£ng Xáº¿p Háº¡ng ---
				return (
					<div>
						{/* TiÃªu Ä‘á» chÃ­nh táº­p trung vÃ o BXH */}
						<h1 className="text-3xl font-extrabold text-center text-purple-700 mb-8">ğŸ† Báº£ng Xáº¿p Háº¡ng Tá»•ng Äiá»ƒm ToÃ n Thá»i Gian</h1>
						
						{/* Báº¢NG Xáº¾P Háº NG Tá»”NG ÄIá»‚M TOÃ€N THá»œI GIAN */}
						<div className="mb-10 p-5 bg-blue-50 border border-blue-200 rounded-xl shadow-xl">
							<h2 className="text-2xl font-bold text-blue-800 mb-4 text-center border-b pb-2">Danh sÃ¡ch Xáº¿p Háº¡ng</h2>
							<div className="space-y-3">
								{allTimeScores.map((p, index) => (
									<div key={p.name} className={`flex justify-between items-center p-3 rounded-lg transition duration-150 ${index < 3 ? 'bg-yellow-200 font-extrabold border-l-4 border-yellow-600' : 'bg-white border hover:bg-gray-50'}`}>
										
										<div className="flex items-center text-xl flex-grow overflow-hidden">
											
											{/* Rank/Number Holder */}
											<span className="font-extrabold w-10 text-right mr-3 flex-shrink-0">
												{index === 0 && 'ğŸ¥‡'}
												{index === 1 && 'ğŸ¥ˆ'}
												{index === 2 && 'ğŸ¥‰'}
												{index >= 3 && <span className="text-gray-500">{index + 1}.</span>}
											</span>
											
											{/* Player Name */}
											<span className="truncate">
												{p.name}
											</span>
										</div>
										
										{/* Score */}
										<span className={`text-2xl font-extrabold ${p.totalScore >= 0 ? 'text-green-600' : 'text-red-600'} flex-shrink-0`}>
											{p.totalScore > 0 ? `+${p.totalScore}` : p.totalScore}
										</span>
									</div>
								))}
							</div>
						</div>

						{/* ÄÃƒ LOáº I Bá» PHáº¦N CHI TIáº¾T CÃC PHIÃŠN */}
						
						<div className="text-center mt-8">
							<a href="index.html" className="inline-block bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition shadow-lg text-lg">
								â†©ï¸ Quay láº¡i Game
							</a>
						</div>
					</div>
				);
			}

			const root = ReactDOM.createRoot(document.getElementById("root"));
			root.render(<HistoryApp />);
		</script>
</body>
</html>

