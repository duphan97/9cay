<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìú L·ªãch s·ª≠ c√°c phi√™n ch∆°i Binh 9 C√¢y</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .summary-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-left: 5px solid;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
    <div id="root" class="w-full max-w-2xl"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --------------------------------------------------------------------------------------
        // --- GITHUB CONSTANTS (B·∫ÆT BU·ªòC THAY TH·∫æ) ---
        // !!! QUAN TR·ªåNG: C·∫¶N THAY TH·∫æ 'YOUR_PAT_TOKEN'
        const GITHUB_TOKEN = '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'; 
        const REPO_OWNER = 'duphan97';
        const REPO_NAME = '9cay';
        const DATA_FILE_PATH = 'data/session_history.json'; 

        const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;
        // --------------------------------------------------------------------------------------

        // H√†m h·ªó tr·ª£ format ng√†y gi·ªù
        const formatDate = (isoString) => {
            const date = new Date(isoString);
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        };

        function HistoryApp() {
            const [sessions, setSessions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // Fetch data t·ª´ GitHub API
            useEffect(() => {
                const fetchHistory = async () => {
                    setLoading(true);
                    setError(null);
                    
                    try {
                        const getResponse = await fetch(GITHUB_API_URL, {
                            method: 'GET',
                            headers: {
                                'Authorization': `token ${GITHUB_TOKEN}`,
                                'Accept': 'application/vnd.github.v3+json',
                            },
                        });

                        if (getResponse.status === 404) {
                            setError("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y file l·ªãch s·ª≠. H√£y ch∆°i 1 v√°n v√† l∆∞u l·∫°i!");
                            setSessions([]);
                        } else if (!getResponse.ok) {
                             const errorText = await getResponse.text();
                             throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu: ${getResponse.status}. Token ho·∫∑c repo c√≥ v·∫•n ƒë·ªÅ.`);
                        }

                        const fileData = await getResponse.json();
                        
                        // Gi·∫£i m√£ n·ªôi dung Base64 (atob) v√† parse th√†nh JSON
                        const content = atob(fileData.content);
                        const data = JSON.parse(content);

                        // L∆∞u tr·ªØ d·ªØ li·ªáu v√†o state (ƒë·∫£o ng∆∞·ª£c th·ª© t·ª± ƒë·ªÉ session m·ªõi nh·∫•t l√™n ƒë·∫ßu)
                        setSessions(data.reverse());

                    } catch (e) {
                        console.error("L·ªói fetch l·ªãch s·ª≠:", e);
                        setError(`‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi GitHub API. Chi ti·∫øt: ${e.message}`);
                        setSessions([]);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchHistory();
            }, []); // Ch·ªâ ch·∫°y m·ªôt l·∫ßn khi component mount

            const totalSessions = sessions.length;

            return (
                <div className="bg-white rounded-2xl shadow-xl p-6 w-full">
                    <h1 className="text-3xl font-bold text-center mb-6 text-indigo-700">üìú L·ªãch s·ª≠ c√°c phi√™n ch∆°i ({totalSessions})</h1>
                    <div className="text-center mb-4">
                       <a href="./index.html" className="text-blue-600 hover:text-blue-800 font-medium underline">
                            &larr; Quay l·∫°i m√†n h√¨nh ch∆°i
                       </a>
                    </div>
                    
                    {loading && (
                        <div className="flex justify-center items-center h-48">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                            <p className="ml-3 text-gray-600">ƒêang t·∫£i l·ªãch s·ª≠ t·ª´ GitHub...</p>
                        </div>
                    )}

                    {error && (
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 font-medium" role="alert">
                            <p className="font-bold">L·ªói!</p>
                            <p>{error}</p>
                        </div>
                    )}

                    {!loading && !error && sessions.length === 0 && (
                        <p className="text-gray-500 text-center py-10">Ch∆∞a c√≥ phi√™n ch∆°i n√†o ƒë∆∞·ª£c l∆∞u tr√™n GitHub.</p>
                    )}

                    <div className="space-y-4">
                        {sessions.map((session, index) => {
                            const isCompleted = session.gameStatus === "COMPLETED";
                            const borderColor = isCompleted ? "border-green-500" : "border-gray-400";
                            const titleColor = isCompleted ? "text-green-700" : "text-gray-700";

                            // T√¨m ng∆∞·ªùi chi·∫øn th·∫Øng (ng∆∞·ªùi c√≥ ƒëi·ªÉm cao nh·∫•t)
                            const winner = session.finalResults.reduce((max, p) => (p.score > max.score ? p : max), { score: -Infinity });
                            const loser = session.finalResults.reduce((min, p) => (p.score < min.score ? p : min), { score: Infinity });
                            const totalPlayers = session.finalResults.length;

                            return (
                                <div key={index} className={`summary-card bg-white p-4 rounded-lg shadow ${borderColor}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className={`text-xl font-bold ${titleColor}`}>
                                            {isCompleted ? "‚úÖ Phi√™n ƒê√£ Ho√†n Th√†nh" : "‚ùå Phi√™n B·ªã Reset"}
                                        </h3>
                                        <span className="text-sm text-gray-500 whitespace-nowrap">
                                            {formatDate(session.timestamp)}
                                        </span>
                                    </div>
                                    
                                    <div className="text-gray-600 text-sm space-y-1">
                                        <p><strong>üïí V√°n ch∆°i:</strong> {session.roundsPlayed} / {session.totalRoundsSet || 'Kh√¥ng gi·ªõi h·∫°n'}</p>
                                        <p><strong>üë• Ng∆∞·ªùi ch∆°i:</strong> {totalPlayers} ng∆∞·ªùi</p>
                                        
                                        {winner.score > loser.score && (
                                            <>
                                                <p className="text-green-600 font-semibold">
                                                    üèÜ Th·∫Øng l·ªõn nh·∫•t: {winner.name} ({winner.score})
                                                </p>
                                                <p className="text-red-600 font-semibold">
                                                    üìâ Thua l·ªõn nh·∫•t: {loser.name} ({loser.score})
                                                </p>
                                            </>
                                        )}
                                    </div>
                                    
                                    {/* Chi ti·∫øt t·ª´ng ng∆∞·ªùi ch∆°i (d·∫°ng b·∫£ng nh·ªè g·ªçn) */}
                                    <div className="mt-3 pt-3 border-t border-gray-200">
                                        <p className="text-sm font-semibold mb-1">Chi ti·∫øt ƒëi·ªÉm cu·ªëi:</p>
                                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-1 text-xs">
                                            {session.finalResults.sort((a,b) => b.score - a.score).map((p, pIndex) => (
                                                <div key={pIndex} className="flex justify-between items-center">
                                                    <span className="truncate text-gray-700">{p.name}</span>
                                                    <span className={`font-bold ${p.score >= 0 ? 'text-green-600' : 'text-red-600'}`}>{p.score}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<HistoryApp />);
    </script>
</body>
</html>



